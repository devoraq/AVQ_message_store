# Архитектура Message Store Service

Сервис следует принципам чистой архитектуры с явным разделением ответственности между слоями. Такая организация упрощает тестирование, позволяет подменять инфраструктурные детали и облегчает расширение продукта.

## Общая схема

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌──────────────┐
│ delivery    │ --> │ usecase      │ --> │ domain      │ <-- │ repository   │
│ (HTTP/gRPC) │     │ (сценарии)   │     │ (модели)    │     │ (MongoDB)    │
└─────────────┘     └──────────────┘     └─────────────┘     └──────────────┘
        ↑                   │                    │                     │
        │                   │                    └──── независим от инфраструктуры
        │                   │
        └────── `internal/app` управляет зависимостями и жизненным циклом
```

## Слои проекта

- **`cmd/server`** — точка входа. Инициализирует логгер, загружает конфигурацию и запускает приложение.
- **`internal/app`** — отвечает за сборку контейнера зависимостей, старт и остановку HTTP/горутины, управление воркерами.
- **`internal/usecase`** — прикладные сценарии. Здесь описано, как сервис обрабатывает входящие сообщения, взаимодействует с доменными сущностями и вызывает инфраструктурные адаптеры.
- **`internal/domain`** — чистые доменные модели и интерфейсы. Слой не знает о транспортных протоколах и реализациях хранилищ.
- **`internal/adapter/delivery`** — входные адаптеры (HTTP/gRPC). Они преобразуют запросы в команды для usecase-слоя и возвращают ответы.
- **`internal/adapter/repository`** — выходные адаптеры. Содержат реализации интерфейсов чтения/записи сообщений поверх MongoDB и других внешних сервисов.
- **`internal/infrastructure`** — общие сервисы: конфигурация, логирование, клиенты БД, retry-политика.
- **`pkg`** — вспомогательные утилиты, которые можно переиспользовать в других сервисах.

## Поток обработки сообщения

1. Сообщение передаётся в соответствующий usecase (`internal/usecase`), который проверяет доменные инварианты и вызывает доменную модель.
2. Usecase обращается к интерфейсу репозитория (`internal/domain`), который реализован в `internal/adapter/repository` и сохраняет сообщение в MongoDB.
3. После успешной записи usecase инициирует commit/acknowledge исходному сервису.

## Зависимости между слоями

- Входные адаптеры зависят от usecase-интерфейсов.
- Usecase-слой зависит от доменных интерфейсов.
- Инфраструктурные реализации (репозитории, клиенты) зависят от внешних библиотек (MongoDB драйвер и т. д.).
- `internal/app` связывает слои, настраивает retry-механику и передаёт ранее сконфигурированные зависимости.
