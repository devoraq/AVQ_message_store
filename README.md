# Message Store Service

Сервис хранения сообщений, предназначенный для приёма данных от веб-сокет подключения, последующей записи событий в MongoDB и подтверждения обработки исходному сервису.

## Возможности
- приём последовательности сообщений по веб-сокету и гарантия их сохранности;
- запись структуры сообщения в MongoDB с учётом повторных попыток;
- подтверждение (commit) обработанного сообщения инициатору отправки;
- конфигурируемый HTTP-контур и политика повторов через YAML/переменные окружения.

## Архитектура
Проект организован по принципам чистой архитектуры:

- `cmd/server` — точка входа, инициализация приложения и инфраструктуры;
- `internal/app` — сборка контейнера зависимостей и жизненный цикл сервисов;
- `internal/usecase` — сценарии (application services), инкапсулирующие бизнес-правила;
- `internal/domain` — предметные сущности и интерфейсы, не зависящие от инфраструктуры;
- `internal/adapter` — входные контроллеры и выходные реализации (HTTP, MongoDB и др.);
- `internal/infrastructure` — общая инфраструктура: конфигурация, логирование, клиента БД;
- `pkg` — переиспользуемые вспомогательные пакеты.

Расширенное описание разнослойной структуры находится в `docs/architecture.md`.

## Требования
- Go `1.23.5` или выше;
- локальный или удалённый MongoDB (реплика сет рекомендуется для гарантированных подтверждений);
- make (для удобного запуска команд, опционально).

## Быстрый старт
```bash
git clone git@github.com:devoraq/AVQ_message_store.git
cd backend/message_store
cp config/config.example.yaml config/config.yaml  # при необходимости подготовьте свой конфиг
make build
./bin/app
```

Во время разработки можно запускать сервис прямым `go run ./cmd/server/main.go`.

## Конфигурация
Основной файл конфигурации: `config/config.yaml`. Любой параметр можно переопределить через переменные окружения:

- `APP_HTTP_ENABLED`, `APP_GRPC_ENABLED` — включение HTTP/GRPC контуров;
- `HTTP_ADDR`, `HTTP_READ_HEADER_TIMEOUT`, `HTTP_READ_TIMEOUT`, `HTTP_WRITE_TIMEOUT`, `HTTP_IDLE_TIMEOUT` — сетевые настройки HTTP-сервера;
- Параметры раздела `retry` управляют стратегией повторов при обращении к MongoDB и другим зависимостям.

Если конфиг отсутствует или пустой, приложение аварийно завершится — это защищает от случайного запуска без настроек.

## Разработка и проверка
- `make run` — собрать и запустить сервис;
- `make test` / `make test-race` — прогон тестов;
- `make lint` — статический анализ и форматирование;
- `make ci` — полный набор проверок, используемый в CI.

## Документация
- `docs/architecture.md` — описание слоёв и зависимостей по чистой архитектуре;
- `docs/` также содержит соглашения по ветвлению и коммитам.

